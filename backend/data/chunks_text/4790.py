- Defines a function `upsert_in_db()` that takes in a Couchbase bucket and a new user object (`UserCreate`) as arguments. It also accepts an optional parameter `persist_to`, which specifies how long to wait for data durability guarantees before returning from this method. The default value is 0, meaning no durability guarantee is required. - Retrieves the document ID of the user based on their username using the `get_doc_id()` helper function. - Calculates the hash of the user's password using the `get_password_hash()` helper function. - Creates a new `UserInDB` instance by converting the input `UserCreate` object into a dictionary and adding the calculated password hash. This class represents the user model stored in Couchbase. - Encodes the `UserInDB` instance into JSON format using the `jsonable_encoder()` utility function provided by Pydantic. - Upserts the encoded user data into Couchbase using the `Bucket.upsert()` method. The `with` statement ensures that the transaction completes successfully or rolls back if any errors occur during execution. - Returns the newly created or updated user object.