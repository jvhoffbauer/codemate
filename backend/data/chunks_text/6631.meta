{"original_code": "def ep_middleware_auth(ep):\n    credentials_var = contextvars.ContextVar(\"credentials\")\n\n    @contextlib.asynccontextmanager\n    async def ep_middleware(ctx: JsonRpcContext):\n        credentials = await security(ctx.http_request)\n        credentials = auth_user(credentials)\n        credentials_var_token = credentials_var.set(credentials)\n\n        try:\n            yield\n        finally:\n            credentials_var.reset(credentials_var_token)\n\n    ep.middlewares.append(ep_middleware)\n\n    @ep.method()\n    def probe() -> str:\n        return credentials_var.get().username\n\n    return ep"}