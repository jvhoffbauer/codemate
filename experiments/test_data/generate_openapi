from fluento import config

config.PARTIAL_INIT = True

import json
import sys

from fastapi.routing import APIRoute
from fluento import main


def main():
    output_file = sys.argv[1]

    # Set operation IDs to route names
    app = main.app
    for route in app.routes:
        if isinstance(route, APIRoute):
            route.operation_id = route.name
            route.tags = route.endpoint.__module__.split(".")[2:]

    # Generate OpenAPI schema
    openapi_def = app.openapi()

    # Write to file
    with open(output_file, "w") as f:
        f.write(json.dumps(openapi_def, indent=4))
