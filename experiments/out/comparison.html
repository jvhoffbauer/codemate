<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>filename</th>
      <th>example</th>
      <th>unixcoder #0</th>
      <th>unixcoder #1</th>
      <th>unixcoder #2</th>
      <th>cocosoda #0</th>
      <th>cocosoda #1</th>
      <th>cocosoda #2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>serve_model_llm</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from potassium import Potassium, Request, Response<br>from transformers import AutoTokenizer<br>from auto_gptq import AutoGPTQForCausalLM<br><br>MODEL_NAME_OR_PATH = "TheBloke/vicuna-33B-GPTQ"<br>MODEL_BASENAME = "vicuna-33b-GPTQ-4bit--1g.act.order"<br>DEVICE = "cuda:0"<br><br>app = Potassium("my_app") <br>[CURSOR]<br>@app.init<br>def init() -> dict:<br>    """Initialize the application with the model and tokenizer."""<br>    tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME_OR_PATH, use_fast=True)<br>    model = AutoGPTQForCausalLM.from_quantized(MODEL_NAME_OR_PATH,<br>        model_basename=MODEL_BASENAME,  <br>        use_safetensors=True,<br>        trust_remote_code=True,<br>        device=DEVICE,<br>        use_triton=False,<br>        quantize_config=None)<br>    return {<br>        "model": model,<br>        "tokenizer": tokenizer<br>    }<br>    <br>@app.handler()<br>def handler(context: dict, request: Request) -> Response:<br>    """Handle a request to generate text from a prompt."""<br>    system = "A chat between a curious user and an artificial intelligence assistant. The assistant gives helpful, detailed, and polite answers to the user's questions."<br>    prompt = request.json.get("prompt")<br>    prompt_template = f"### System:\n{system}\n\n### User:\n{prompt}\n\n### Assistant:\n"<br>    temperature = request.json.get("temperature", 0.7)<br>    max_new_tokens = request.json.get("max_new_tokens", 512)<br>    model = context.get("model")<br>    tokenizer = context.get("tokenizer")<br>    input_ids = tokenizer(prompt_template, return_tensors='pt').input_ids.cuda()<br>    output = model.generate(inputs=input_ids, temperature=temperature, max_new_tokens=max_new_tokens)<br>    result = tokenizer.decode(output[0])<br>    return Response(json={"outputs": result}, status=200)<br><br>if __name__ == "__main__":<br>    app.serve()</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333"># Copyright (c) Microsoft Corporation. All rights reserved.<br># Licensed under the MIT License.<br>from collections import defaultdict<br>import os<br>from dotenv import load_dotenv, find_dotenv<br>from fastapi import Body, FastAPI<br>from starlette.middleware.cors import CORSMiddleware<br>from starlette.responses import RedirectResponse<br>import spacy<br>import srsly<br>import uvicorn<br>from app.models import (<br>    ENT_PROP_MAP,<br>    RecordsRequest,<br>    RecordsResponse,<br>    RecordsEntitiesByTypeResponse,<br>)<br>from app.spacy_extractor import SpacyExtractor<br>app = FastAPI(<br>    title="{{cookiecutter.project_name}}",<br>    version="1.0",<br>    description="{{cookiecutter.short_description}}",<br>)<br>example_request = srsly.read_json("app/data/example_request.json")<br>nlp = spacy.load("{{cookiecutter.spacy_model}}")<br>extractor = SpacyExtractor(nlp)<br>@app.get("/", include_in_schema=False)<br>def docs_redirect():<br>    return RedirectResponse(f"/docs")<br>@app.post("/entities", response_model=RecordsResponse, tags=["NER"])</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import logging<br>from typing import TYPE_CHECKING<br>from uuid import uuid4<br><br>import pytest<br>from fastapi import Request, Response<br>from httpx import AsyncClient<br>from starlette.testclient import TestClient<br><br>from asgi_correlation_id.middleware import FAILED_VALIDATION_MESSAGE, is_valid_uuid4<br>from tests.conftest import (<br>    TRANSFORMER_VALUE,<br>    default_app,<br>    generator_app,<br>    no_validator_or_transformer_app,<br>    transformer_app,<br>    update_request_header_app,<br>)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from datetime import datetime, timedelta<br>from typing import List, Union<br>from fastapi import Depends, FastAPI, HTTPException, Security, status<br>from fastapi.security import (<br>    OAuth2PasswordBearer,<br>    OAuth2PasswordRequestForm,<br>    SecurityScopes,<br>)<br>from jose import JWTError, jwt<br>from passlib.context import CryptContext<br>from pydantic import BaseModel, ValidationError<br>from typing_extensions import Annotated<br># to get a string like this run:<br># openssl rand -hex 32<br>SECRET_KEY = "09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"<br>ALGORITHM = "HS256"<br>ACCESS_TOKEN_EXPIRE_MINUTES = 30<br>fake_users_db = {<br>    "johndoe": {<br>        "username": "johndoe",<br>        "full_name": "John Doe",<br>        "email": "johndoe@example.com",<br>        "hashed_password": "$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW",<br>        "disabled": False,<br>    },<br>    "alice": {<br>        "username": "alice",<br>        "full_name": "Alice Chains",<br>        "email": "alicechains@example.com",</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">## Example<br><br>        ```python<br>        from fastapi import FastAPI<br>        from pydantic import BaseModel</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">## Example<br><br>        ```python<br>        from fastapi import FastAPI<br>        from pydantic import BaseModel</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">## Example<br><br>        ```python<br>        from fastapi import FastAPI<br>        from pydantic import BaseModel</code></pre></div></td>
    </tr>
    <tr>
      <td>auth_implemented</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import HTTPException, Request<br>from firebase_admin import auth as firebase_auth<br>from firebase_admin.auth import (<br>    CertificateFetchError,<br>    ExpiredIdTokenError,<br>    InvalidIdTokenError,<br>    RevokedIdTokenError,<br>    UserDisabledError,<br>)<br><br>from app import models<br><br>PUBLIC_ROUTES = [<br>    "/api/auth/signup", [CURSOR]<br>]<br><br><br>class FirebaseAuthMiddleware:<br>    async def __call__(self, request: Request, call_next, *args, **kwargs):<br>        # Check if the route is public<br>        if (<br>            not request.url.path.startswith("/api")<br>            or request.method == "OPTIONS"<br>            or any([request.url.path.startswith(r) for r in PUBLIC_ROUTES])<br>        ):<br>            return await call_next(request)<br><br>        # Check if the user is logged in<br>        else:<br>            # Get the authorization header<br>            authorization_header = request.headers.get("Authorization")<br><br>            # Ensure the authorization header is present<br>            if not authorization_header:<br>                raise HTTPException(status_code=400, detail="Missing auth token")<br><br>            # Try to verify the token and get the user<br>            try: [CURSOR]<br>                user = firebase_auth.verify_id_token(authorization_header)<br>                request.state.firebase_user = user<br>                request.state.user = models.get_user(user["uid"])<br>            except (<br>                ValueError,<br>                InvalidIdTokenError,<br>                ExpiredIdTokenError,<br>                RevokedIdTokenError,<br>                CertificateFetchError,<br>                UserDisabledError,<br>            ):<br>                raise HTTPException(status_code=400, detail="Invalid auth token")<br><br>            # Run the function<br>            return await call_next(request)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import APIRouter, Depends, HTTPException<br>from fastapi.security import OAuth2PasswordRequestForm<br>from sqlalchemy.ext.asyncio import AsyncSession<br>from app.api.deps import get_session<br>from app.core.security import authenticate, create_access_token<br>from app.schemas.token import Token<br>router = APIRouter(tags=["Login"])<br>@router.post("/login/", response_model=Token)<br>async def login(<br>    data: OAuth2PasswordRequestForm = Depends(),<br>    session: AsyncSession = Depends(get_session),<br>):<br>    user = await authenticate(session, email=data.username, password=data.password)<br>    if user is None:<br>        raise HTTPException(status_code=400, detail="Incorrect email or password")<br>    if not user.is_active:<br>        raise HTTPException(status_code=400, detail="Inactive user")<br>    return {"access_token": create_access_token(user), "token_type": "bearer"}</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import time<br>import jwt<br>from fastapi import APIRouter, Depends, HTTPException, status<br>from fastapi.security import OAuth2PasswordRequestForm<br>from pydantic import ValidationError<br>from sqlalchemy import select<br>from sqlalchemy.ext.asyncio import AsyncSession<br>from app.api import deps<br>from app.core import config, security<br>from app.models import User<br>from app.schemas.requests import RefreshTokenRequest<br>from app.schemas.responses import AccessTokenResponse<br>router = APIRouter()<br>@router.post("/access-token", response_model=AccessTokenResponse)<br>async def login_access_token(<br>    session: AsyncSession = Depends(deps.get_session),<br>    form_data: OAuth2PasswordRequestForm = Depends(),<br>):<br>    """OAuth2 compatible token, get an access token for future requests using username and password"""<br>    result = await session.execute(select(User).where(User.email == form_data.username))<br>    user = result.scalars().first()<br>    if user is None:</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">response = client.get("/simple")<br>    assert response.json()["env"] == "FALSE"<br>    response = client.get("/asimple")<br>    assert response.json()["env"] == "FALSE"<br>    # confirm the Custom APIRoute class fix<br>    response = client.get("/future")<br>    assert response.json()["env"] == "FALSE"<br>    response = client.get("/afuture")<br>    assert response.json()["env"] == "FALSE"<br>def test_register_deps():<br>    """Test add_route_dependencies."""<br>    http_basic = security.HTTPBasic()<br>    def must_be_bob(credentials: security.HTTPBasicCredentials = Depends(http_basic)):<br>        if credentials.username == "bob":<br>            return True<br>        raise HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED,<br>            detail="You're not Bob",<br>            headers={"WWW-Authenticate": "Basic"},<br>        )<br>    app = FastAPI()<br>    @app.get("/one")<br>    def one():<br>        """one."""<br>        return "one"<br>    @app.get("/two")<br>    def two():<br>        """two."""<br>        return "two"</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import jwt<br>from fastapi import APIRouter, Depends, HTTPException, status<br>from fastapi.security import OAuth2PasswordRequestForm<br>from pydantic import ValidationError<br>from sqlalchemy import select</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import time<br>import jwt<br>from fastapi import APIRouter, Depends, HTTPException, status<br>from fastapi.security import OAuth2PasswordRequestForm<br>from pydantic import ValidationError<br>from sqlalchemy import select<br>from sqlalchemy.ext.asyncio import AsyncSession<br>from app.api import deps<br>from app.core import config, security<br>from app.models import User<br>from app.schemas.requests import RefreshTokenRequest<br>from app.schemas.responses import AccessTokenResponse<br>router = APIRouter()<br>@router.post("/access-token", response_model=AccessTokenResponse)<br>async def login_access_token(<br>    session: AsyncSession = Depends(deps.get_session),<br>    form_data: OAuth2PasswordRequestForm = Depends(),<br>):<br>    """OAuth2 compatible token, get an access token for future requests using username and password"""<br>    result = await session.execute(select(User).where(User.email == form_data.username))<br>    user = result.scalars().first()<br>    if user is None:</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import time<br><br>import jwt<br>from fastapi import APIRouter, Depends, HTTPException, status<br>from fastapi.security import OAuth2PasswordRequestForm<br>from pydantic import ValidationError<br>from sqlalchemy import select<br>from sqlalchemy.ext.asyncio import AsyncSession</code></pre></div></td>
    </tr>
    <tr>
      <td>uvicorn_main</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">def main():<br>    uvicorn.run(<br>        "fluento.main:app", port=5001, reload=True, workers=1, timeout_keep_alive=30<br>    )<br>[CURSOR]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import uvicorn<br>    # 官方推荐是用命令后启动 uvicorn main:app --host=127.0.0.1 --port=8150 --reload<br>    uvicorn.run(app="main:app", host="127.0.0.1", port=8151, reload=False, debug=True)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333"># 暂停和恢复任务 暂时没看<br><br><br>if __name__ == "__main__":<br>    import uvicorn<br><br>    # 官方推荐是用命令后启动 uvicorn main:app --host=127.0.0.1 --port=8150 --reload<br>    uvicorn.run(app="main:app", host="127.0.0.1", port=8151, reload=False, debug=True)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333"># 暂停和恢复任务 暂时没看<br><br><br>if __name__ == "__main__":<br>    import uvicorn<br><br>    # 官方推荐是用命令后启动 uvicorn main:app --host=127.0.0.1 --port=8150 --reload<br>    uvicorn.run(app="main:app", host="127.0.0.1", port=8151, reload=False, debug=True)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">if __name__ == "__main__":<br>    import uvicorn<br><br>    uvicorn.run(app, host="0.0.0.0", port=8888, log_level="info")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">if __name__ == "__main__":<br>    import uvicorn<br><br>    uvicorn.run(app, host="0.0.0.0", port=8888, log_level="info")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333"># Running of app.<br>if __name__ == "__main__":<br>    uvicorn.run(<br>        "app.main:APP",<br>        host="127.0.0.1",<br>        port=SETTINGS.port,<br>        log_level="info",<br>    )</code></pre></div></td>
    </tr>
    <tr>
      <td>auth_outline</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import HTTPException, Request<br><br><br>class AuthMiddleware:<br>    async def __call__(self, request: Request, call_next, *args, **kwargs):<br>        <br>        # Get the authorization header<br>        authorization_header = request.headers.get("Authorization")<br><br>        # Ensure the authorization header is present<br>        if not authorization_header:<br>                raise HTTPException(status_code=400, detail="Missing auth token")<br><br>        # Try to verify the token and get the user<br>        try:<br>            # Check if we have the token<br>            pass [CURSOR]<br>        except ValueError:<br>            raise HTTPException(status_code=400, detail="Invalid auth token")<br><br>        # Run the function<br>        return await call_next(request)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">async def __call__(<br>        self, request: Request<br>    ) -> Optional[HTTPAuthorizationCredentials]:<br>        authorization = request.headers.get("Authorization")<br>        scheme, credentials = get_authorization_scheme_param(authorization)<br>        if not (authorization and scheme and credentials):<br>            if self.auto_error:<br>                raise HTTPException(<br>                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"<br>                )<br>            else:<br>                return None<br>        if scheme.lower() != "bearer":<br>            if self.auto_error:<br>                raise HTTPException(<br>                    status_code=HTTP_403_FORBIDDEN,<br>                    detail="Invalid authentication credentials",<br>                )<br>            else:<br>                return None<br>        return HTTPAuthorizationCredentials(scheme=scheme, credentials=credentials)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">else:<br>                return None<br>        invalid_user_credentials_exc = HTTPException(<br>            status_code=HTTP_401_UNAUTHORIZED,<br>            detail="Invalid authentication credentials",<br>            headers=unauthorized_headers,<br>        )<br>        try:<br>            data = b64decode(param).decode("ascii")<br>        except (ValueError, UnicodeDecodeError, binascii.Error):<br>            raise invalid_user_credentials_exc  # noqa: B904<br>        username, separator, password = data.partition(":")<br>        if not separator:<br>            raise invalid_user_credentials_exc<br>        return HTTPBasicCredentials(username=username, password=password)<br>class HTTPBearer(HTTPBase):<br>    """<br>    HTTP Bearer token authentication.<br>    ## Usage<br>    Create an instance object and use that object as the dependency in `Depends()`.<br>    The dependency result will be an `HTTPAuthorizationCredentials` object containing<br>    the `scheme` and the `credentials`.<br>    ## Example<br>    ```python</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">async def __call__(<br>        self, request: Request<br>    ) -> Optional[HTTPAuthorizationCredentials]:<br>        authorization = request.headers.get("Authorization")<br>        scheme, credentials = get_authorization_scheme_param(authorization)<br>        if not (authorization and scheme and credentials):<br>            if self.auto_error:<br>                raise HTTPException(<br>                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"<br>                )<br>            else:<br>                return None<br>        return HTTPAuthorizationCredentials(scheme=scheme, credentials=credentials)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import Header, HTTPException<br><br><br>async def get_token_header(x_token: str = Header()):<br>    if x_token!= "fake-super-secret-token":<br>        raise HTTPException(status_code=400, detail="X-Token header invalid")<br><br><br>async def get_query_token(token: str):<br>    if token!= "jessica":<br>        raise HTTPException(status_code=400, detail="No Jessica token provided")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from typing import Annotated<br><br>from fastapi import Header, HTTPException<br><br><br>async def get_token_header(x_token: Annotated[str, Header()]):<br>    if x_token!= "fake-super-secret-token":<br>        raise HTTPException(status_code=400, detail="X-Token header invalid")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import Header, HTTPException<br>from typing_extensions import Annotated<br><br><br>async def get_token_header(x_token: Annotated[str, Header()]):<br>    if x_token!= "fake-super-secret-token":<br>        raise HTTPException(status_code=400, detail="X-Token header invalid")</code></pre></div></td>
    </tr>
    <tr>
      <td>generate_openapi</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fluento import config<br><br>config.PARTIAL_INIT = True<br><br>import json<br>import sys<br><br>from fastapi.routing import APIRoute<br><br>from fluento import main<br><br>output_file = sys.argv[1]<br><br># Set operation IDs to route names<br>app = main.app<br>for route in app.routes:<br>    if isinstance(route, APIRoute):<br>        route.operation_id = route.name<br>        route.tags = route.endpoint.__module__.split(".")[2:]<br><br># Generate OpenAPI schema<br>openapi_def = app.openapi()<br>[CURSOR]<br># Write to file<br>with open(output_file, "w") as f:<br>    f.write(json.dumps(openapi_def, indent=4))</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">return route.name.replace("_", " ").title()<br>def get_openapi_operation_metadata(<br>    *, route: routing.APIRoute, method: str, operation_ids: Set[str]<br>) -> Dict[str, Any]:<br>    operation: Dict[str, Any] = {}<br>    if route.tags:<br>        operation["tags"] = route.tags<br>    operation["summary"] = generate_operation_summary(route=route, method=method)<br>    if route.description:<br>        operation["description"] = route.description<br>    operation_id = route.operation_id or route.unique_id<br>    if operation_id in operation_ids:<br>        message = (<br>            f"Duplicate Operation ID {operation_id} for function "<br>            + f"{route.endpoint.__name__}"<br>        )<br>        file_name = getattr(route.endpoint, "__globals__", {}).get("__file__")<br>        if file_name:<br>            message += f" at {file_name}"<br>        warnings.warn(message, stacklevel=1)<br>    operation_ids.add(operation_id)<br>    operation["operationId"] = operation_id<br>    if route.deprecated:</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">field_info.openapi_examples<br>        )<br>    elif field_info.example != Undefined:<br>        request_media_content["example"] = jsonable_encoder(field_info.example)<br>    request_body_oai["content"] = {request_media_type: request_media_content}<br>    return request_body_oai<br>def generate_operation_id(<br>    *, route: routing.APIRoute, method: str<br>) -> str:  # pragma: nocover<br>    warnings.warn(<br>        "fastapi.openapi.utils.generate_operation_id() was deprecated, "<br>        "it is not used internally, and will be removed soon",<br>        DeprecationWarning,<br>        stacklevel=2,<br>    )<br>    if route.operation_id:<br>        return route.operation_id<br>    path: str = route.path_format<br>    return generate_operation_id_for_path(name=route.name, path=path, method=method)<br>def generate_operation_summary(*, route: routing.APIRoute, method: str) -> str:<br>    if route.summary:<br>        return route.summary<br>    return route.name.replace("_", " ").title()<br>def get_openapi_operation_metadata(</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">def get_openapi_operation_metadata(<br>    *, route: routing.APIRoute, method: str, operation_ids: Set[str]<br>) -> Dict[str, Any]:<br>    operation: Dict[str, Any] = {}<br>    if route.tags:<br>        operation["tags"] = route.tags<br>    operation["summary"] = generate_operation_summary(route=route, method=method)<br>    if route.description:<br>        operation["description"] = route.description<br>    operation_id = route.operation_id or route.unique_id<br>    if operation_id in operation_ids:<br>        message = (<br>            f"Duplicate Operation ID {operation_id} for function "<br>            + f"{route.endpoint.__name__}"<br>        )<br>        file_name = getattr(route.endpoint, "__globals__", {}).get("__file__")<br>        if file_name:<br>            message += f" at {file_name}"<br>        warnings.warn(message, stacklevel=1)<br>    operation_ids.add(operation_id)<br>    operation["operationId"] = operation_id<br>    if route.deprecated:<br>        operation["deprecated"] = route.deprecated<br>    return operation</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">return route.name.replace("_", " ").title()<br>def get_openapi_operation_metadata(<br>    *, route: routing.APIRoute, method: str, operation_ids: Set[str]<br>) -> Dict[str, Any]:<br>    operation: Dict[str, Any] = {}<br>    if route.tags:<br>        operation["tags"] = route.tags<br>    operation["summary"] = generate_operation_summary(route=route, method=method)<br>    if route.description:<br>        operation["description"] = route.description<br>    operation_id = route.operation_id or route.unique_id<br>    if operation_id in operation_ids:<br>        message = (<br>            f"Duplicate Operation ID {operation_id} for function "<br>            + f"{route.endpoint.__name__}"<br>        )<br>        file_name = getattr(route.endpoint, "__globals__", {}).get("__file__")<br>        if file_name:<br>            message += f" at {file_name}"<br>        warnings.warn(message, stacklevel=1)<br>    operation_ids.add(operation_id)<br>    operation["operationId"] = operation_id<br>    if route.deprecated:</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">def get_openapi_operation_metadata(<br>    *, route: routing.APIRoute, method: str, operation_ids: Set[str]<br>) -> Dict[str, Any]:<br>    operation: Dict[str, Any] = {}<br>    if route.tags:<br>        operation["tags"] = route.tags<br>    operation["summary"] = generate_operation_summary(route=route, method=method)<br>    if route.description:<br>        operation["description"] = route.description<br>    operation_id = route.operation_id or route.unique_id<br>    if operation_id in operation_ids:<br>        message = (<br>            f"Duplicate Operation ID {operation_id} for function "<br>            + f"{route.endpoint.__name__}"<br>        )<br>        file_name = getattr(route.endpoint, "__globals__", {}).get("__file__")<br>        if file_name:<br>            message += f" at {file_name}"<br>        warnings.warn(message, stacklevel=1)<br>    operation_ids.add(operation_id)<br>    operation["operationId"] = operation_id<br>    if route.deprecated:<br>        operation["deprecated"] = route.deprecated<br>    return operation</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">DeprecationWarning,<br>        stacklevel=2,<br>    )<br>    operation_id = name + path<br>    operation_id = re.sub(r"\W", "_", operation_id)<br>    operation_id = operation_id + "_" + method.lower()<br>    return operation_id<br>def generate_unique_id(route: "APIRoute") -> str:<br>    operation_id = route.name + route.path_format<br>    operation_id = re.sub(r"\W", "_", operation_id)<br>    assert route.methods<br>    operation_id = operation_id + "_" + list(route.methods)[0].lower()<br>    return operation_id<br>def deep_dict_update(main_dict: Dict[Any, Any], update_dict: Dict[Any, Any]) -> None:<br>    for key, value in update_dict.items():<br>        if (<br>            key in main_dict<br>            and isinstance(main_dict[key], dict)<br>            and isinstance(value, dict)<br>        ):<br>            deep_dict_update(main_dict[key], value)<br>        elif (<br>            key in main_dict<br>            and isinstance(main_dict[key], list)<br>            and isinstance(update_dict[key], list)<br>        ):</code></pre></div></td>
    </tr>
    <tr>
      <td>healthcheck</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import APIRouter<br><br>router = APIRouter(tags=["health"])<br><br><br>@router.get("/health", responses={200: {"description": "Health check"}})<br>def health():<br>    return {"status": "ok"}[CURSOR]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@app.get("/healthcheck", include_in_schema=False)<br>async def healthcheck() -> dict[str, str]:<br>    return {"status": "ok"}<br><br><br>app.include_router(auth_router, prefix="/auth", tags=["Auth"])<br>app.include_router(<br>    external_service_router, prefix="/external-service", tags=["External Service Calls"]<br>)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">router = APIRouter(prefix="/health", tags=["Health"])<br><br><br>@router.get("/", status_code=204)<br>async def health(session: AsyncSession = Depends(get_session)):<br>    try:<br>        await asyncio.wait_for(session.execute("SELECT 1"), timeout=1)<br>    except (asyncio.TimeoutError, socket.gaierror):<br>        return Response(status_code=503)<br>    return Response(status_code=204)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from app.api.deps import get_session<br><br>router = APIRouter(prefix="/health", tags=["Health"])<br><br><br>@router.get("/", status_code=204)<br>async def health(session: AsyncSession = Depends(get_session)):<br>    try:<br>        await asyncio.wait_for(session.execute("SELECT 1"), timeout=1)<br>    except (asyncio.TimeoutError, socket.gaierror):<br>        return Response(status_code=503)<br>    return Response(status_code=204)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">router = APIRouter(prefix="/health", tags=["Health"])<br><br><br>@router.get("/", status_code=204)<br>async def health(session: AsyncSession = Depends(get_session)):<br>    try:<br>        await asyncio.wait_for(session.execute("SELECT 1"), timeout=1)<br>    except (asyncio.TimeoutError, socket.gaierror):<br>        return Response(status_code=503)<br>    return Response(status_code=204)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import APIRouter<br><br>from app.api.health import router as health_router<br>from app.api.v1 import router as v1_router</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@app.get("/healthcheck", include_in_schema=False)<br>async def healthcheck() -> dict[str, str]:<br>    return {"status": "ok"}<br><br><br>app.include_router(auth_router, prefix="/auth", tags=["Auth"])<br>app.include_router(<br>    external_service_router, prefix="/external-service", tags=["External Service Calls"]<br>)</code></pre></div></td>
    </tr>
    <tr>
      <td>dependency_injection2</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from http import client<br>from fastapi import APIRouter, HTTPException, status<br>from typing import Annotated<br>from urllib.parse import urlencode, urlparse<br>import uuid<br>from fastapi import Cookie, Depends<br>from fastapi.responses import RedirectResponse<br>from pydantic import BaseModel<br>import requests<br>from jwt import decode<br>import datetime<br>import logging as log<br>from dependency_injector.wiring import Provide, inject<br>from prompto_server.db.session import Session<br>from prompto_server import Container<br>from starlette.responses import FileResponse<br><br>router = APIRouter(<br>    tags=["authentication"],<br>)<br><br><br>@inject<br>async def current_user(<br>    prompto_id: Annotated[str, Cookie()] = None,<br>    auth_service=Depends(Provide[Container.auth_service]),<br>) -> Session:<br>    if not prompto_id:<br>        raise HTTPException(status_code=401, detail="Unauthorized")<br><br>    session = await auth_service.lookup(prompto_id)<br><br>    if not session:<br>        raise HTTPException(status_code=401, detail="Unauthorized")<br><br>    return session<br><br><br>@router.get(<br>    "/auth/login",<br>    status_code=307,<br>    responses={307: {"description": "Redirect to Keycloak"}},<br>)<br>@inject<br>def login(state: str, config=Depends(Provide[Container.config])) -> RedirectResponse:<br>    # TODO Use the state variable of the client<br>    # TODO export URLS<br>    params = {<br>        "response_type": "code",<br>        "scope": "openid email profile",<br>        "client_id": "prompto",<br>        "redirect_uri": config["oidc"]["redirect_url"],<br>        "state": state,<br>        "nonce": "123123",  # TODO implement using nonce [CURSOR]<br>    }<br>    auth_server_url = config["oidc"]["auth_url"] + "?" + urlencode(params)<br>    return RedirectResponse(url=auth_server_url)<br><br><br>@router.get(<br>    "/callback"<br>)  # Required for localhost testing since keycloak has /callback for localhost<br>@router.get(<br>    "/auth/callback",<br>    status_code=302,<br>    responses={<br>        307: {"description": "Redirect to Prompto"},<br>        400: {"description": "Bad request"},<br>    },<br>)<br>@inject<br>async def callback(<br>    code: str,<br>    config=Depends(Provide[Container.config]),<br>    auth_service=Depends(Provide[Container.auth_service]),<br>    signing_key=Depends(Provide[Container.signing_key]),<br>):<br>    headers = {"Content-Type": "application/x-www-form-urlencoded"}<br>    body = {<br>        "code": code,<br>        "client_id": config["oidc"]["client_id"],<br>        "client_secret": config["oidc"]["client_secret"],<br>        "redirect_uri": config["oidc"]["redirect_url"],<br>        "grant_type": "authorization_code",<br>    }<br><br>    idp_response = requests.post(<br>        url=config["oidc"]["token_url"],<br>        data=body,<br>        headers=headers,<br>    )<br>    idp_response.raise_for_status()<br><br>    tokens = idp_response.json()<br>    id_token = tokens["id_token"]<br><br>    # TODO add try catch<br>    token_information = decode(<br>        id_token,<br>        signing_key,<br>        algorithms=["RS512"],<br>        audience="prompto",<br>        issuer=config["oidc"]["url"].rstrip("/"),<br>    )<br>    log.info("Successful login for user %s", token_information["preferred_username"])<br>    session = Session(<br>        uuid=uuid.uuid4(),<br>        username=token_information["preferred_username"],<br>        email=token_information["email"],<br>        expires=int(<br>            (datetime.datetime.now() + datetime.timedelta(days=30)).timestamp()<br>        ),<br>    )<br>    await auth_service.save(session)<br>    # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie<br>    client_redirect_url = config["oidc"]["client_redirect_url"]<br>    hostname = urlparse(config["app"]["host_url"]).hostname<br>    headers = {"Set-Cookie": f"prompto_id={session.uuid}; domain={hostname}; HttpOnly"}<br>    return RedirectResponse(<br>        f"{client_redirect_url}/?prompto_id={session.uuid}", headers=headers<br>    )<br><br><br>class WhoamiResponse(BaseModel):<br>    username: str<br>    expires: int<br><br><br>@router.get("/auth/whoami", responses={401: {"description": "Unauthorized"}})<br>def whoami(session: Annotated[Session, Depends(current_user)]) -> WhoamiResponse:<br>    return WhoamiResponse(username=session.username, expires=session.expires)<br><br><br>class LogoutResponse(BaseModel):<br>    message: str = "Logout successful"<br><br><br>@router.post(<br>    path="/auth/logout",<br>    responses={401: {"description": "Unauthorized"}},<br>)<br>@inject<br>async def logout(<br>    session: Annotated[Session, Depends(current_user)],<br>    auth_service=Depends(Provide[Container.auth_service]),<br>) -> LogoutResponse:<br>    await auth_service.clear(session)<br>    return LogoutResponse()<br><br><br>@router.get(<br>    path="/auth/success",<br>    responses={401: {"description": "Unauthorized"}},<br>)<br>@inject<br>async def success_page(<br>    session: Annotated[Session, Depends(current_user)],<br>    auth_service=Depends(Provide[Container.auth_service]),<br>) -> FileResponse:<br>    return FileResponse("templates/redirect_page.html")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from datetime import timedelta<br>from typing import Any<br>from fastapi import APIRouter, Body, Depends, HTTPException<br>from fastapi.security import OAuth2PasswordRequestForm<br>from sqlalchemy.orm import Session<br>from app import crud, models, schemas<br>from app.api import deps<br>from app.core import security<br>from app.core.config import settings<br>from app.core.security import get_password_hash<br>from app.utils import (<br>    generate_password_reset_token,<br>    send_reset_password_email,<br>    verify_password_reset_token,<br>)<br>router = APIRouter()<br>@router.post("/login/access-token", response_model=schemas.Token)<br>def login_access_token(<br>    db: Session = Depends(deps.get_db), form_data: OAuth2PasswordRequestForm = Depends()<br>) -> Any:<br>    """<br>    OAuth2 compatible token login, get an access token for future requests<br>    """<br>    user = crud.user.authenticate(<br>        db, email=form_data.username, password=form_data.password<br>    )<br>    if not user:</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">This is only used if you use OAuth2 (with the "Authorize" button)<br>                with Swagger UI.<br>                """<br>            ),<br>        ] = "/docs/oauth2-redirect",</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@router.post("/login/access-token", response_model=schemas.Token)<br>def login_access_token(<br>    db: Session = Depends(deps.get_db), form_data: OAuth2PasswordRequestForm = Depends()<br>) -> Any:<br>    """<br>    OAuth2 compatible token login, get an access token for future requests<br>    """<br>    user = crud.user.authenticate(<br>        db, email=form_data.username, password=form_data.password<br>    )<br>    if not user:<br>        raise HTTPException(status_code=400, detail="Incorrect email or password")<br>    elif not crud.user.is_active(user):<br>        raise HTTPException(status_code=400, detail="Inactive user")<br>    access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)<br>    return {<br>        "access_token": security.create_access_token(<br>            user.id, expires_delta=access_token_expires<br>        ),<br>        "token_type": "bearer",<br>    }</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">This is only used if you use OAuth2 (with the "Authorize" button)<br>                with Swagger UI.<br>                """<br>            ),<br>        ] = "/docs/oauth2-redirect",</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">] = "/docs/oauth2-redirect",<br>        swagger_ui_init_oauth: Annotated[<br>            Optional[Dict[str, Any]],<br>            Doc(<br>                """</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">By default it is `/docs/oauth2-redirect`.</code></pre></div></td>
    </tr>
    <tr>
      <td>translation_api</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import logging<br><br>import langcodes<br>from fastapi import APIRouter, Request<br>from fastapi_camelcase import CamelModel<br>from google.cloud import translate_v3 as translate<br><br>from fluento import config, models, schemas<br>from fluento.wrapper import mixpanel<br><br>router = APIRouter(prefix="/api/translation")<br>logger = logging.getLogger(__name__)<br><br><br>translation_client = translate.TranslationServiceClient.from_service_account_file(<br>    config.GC_TRANSLATION_CREDENTIALS<br>)<br><br><br>@router.post("")<br>def call_translate(<br>    request: Request, data: schemas.TranslationInput<br>) -> schemas.TranslationResult:<br>    # Limit text length to avoid abuse<br>    if len(data.text) > 100:<br>        return {"error": "text too long"}, 400<br><br>    # Get native language<br>    native_language = request.state.user.native_language<br>    try:<br>        native_language_code = langcodes.find(native_language).language<br>    except LookupError:<br>        native_language_code = None<br><br>    # Translate text<br>    response = translation_client.translate_text(<br>        request={<br>            "parent": config.GC_TRANSLATION_LOCATION,<br>            "contents": [data.text],<br>            "mime_type": "text/plain",<br>            "target_language_code": "en-US",<br>            "source_language_code": native_language_code,<br>        }<br>    )<br>    translation = response.translations[0].translated_text<br><br>    # Track in Mixpanel<br>    mixpanel.track_in_request(<br>        "Translate in Video Call",<br>        {<br>            "Text": data.text,<br>            "Translation": translation,<br>            "Native Language": native_language,<br>            "Native Language Code": native_language_code,<br>        },<br>        request=request,<br>    )<br><br>    return schemas.TranslationResult(translation=translation) [CURSOR]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">"detail": [<br>                {<br>                    "type": "model_attributes_type",<br>                    "loc": ["body"],<br>                    "msg": "Input should be a valid dictionary or object to extract fields from",<br>                    "input": '{"name": "Foo", "price": 50.5}',<br>                    "url": match_pydantic_error_url(<br>                        "model_attributes_type"<br>                    ),  # "https://errors.pydantic.dev/0.38.0/v/dict_attributes_type",<br>                }<br>            ]<br>        }<br>    ) | IsDict(<br>        # TODO: remove when deprecating Pydantic v1<br>        {<br>            "detail": [<br>                {<br>                    "loc": ["body"],<br>                    "msg": "value is not a valid dict",<br>                    "type": "type_error.dict",<br>                }<br>            ]<br>        }<br>    )<br>    response = client.post(<br>        "/items/", content=data, headers={"Content-Type": "application/geo+json-seq"}<br>    )</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">"continentName": "Europe",<br>            "currencyCode": "EUR",<br>        },<br>        {<br>            "continent": "AS",<br>            "capital": "Abu Dhabi",<br>            "languages": "ar-AE,fa,en,hi,ur",<br>            "geonameId": 290557,<br>            "south": 22.6315119400001,<br>            "isoAlpha3": "ARE",<br>            "north": 26.0693916590001,<br>            "fipsCode": "AE",<br>            "population": "9630959",<br>            "east": 56.381222289,<br>            "isoNumeric": "784",<br>            "areaInSqKm": "82880.0",<br>            "countryCode": "AE",<br>            "west": 51.5904085340001,<br>            "countryName": "United Arab Emirates",<br>            "continentName": "Asia",<br>            "currencyCode": "AED",<br>        },<br>    ]<br>}<br>@responses.activate<br>@pytest.mark.parametrize(<br>    "body_arg, json_arg",<br>    [<br>        (None, SAMPLE_GEONAMES_JSON),<br>        (NOT_FOUND_HTML, None),<br>        (None, {"foo": "bar"}),<br>        (requests.exceptions.Timeout("Forced Timeout"), None),<br>    ],<br>)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import logging<br>from typing import Any, Union<br>from typing_extensions import Literal<br>from fastapi_amis_admin.amis import API<br>from fastapi_amis_admin.utils.pydantic import PYDANTIC_V2, BaseSettings<br>class Settings(BaseSettings):<br>    """Project configuration"""<br>    host: str = "127.0.0.1"<br>    port: int = 8000<br>    debug: bool = False<br>    version: str = "0.0.0"<br>    site_title: str = "FastAPI Amis Admin"<br>    site_icon: str = "https://baidu.gitee.io/amis/static/favicon_b3b0647.png"<br>    site_url: str = ""<br>    site_path: str = "/admin"<br>    database_url_async: str = ""<br>    database_url: str = ""<br>    language: Union[Literal["zh_CN", "en_US", "de_DE"], str] = ""<br>    amis_cdn: str = "https://unpkg.com"<br>    amis_pkg: str = "amis@3.5.2"<br>    amis_theme: Literal["cxd", "antd", "dark", "ang"] = "cxd"<br>    amis_image_receiver: API = None  # Image upload interface<br>    amis_file_receiver: API = None  # File upload interface<br>    logger: Union[logging.Logger, Any] = logging.getLogger("fastapi_amis_admin")</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">"name": "level3",<br>                            "in": "query",<br>                        }<br>                    ],<br>                    "responses": {</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">"name": "level3",<br>                            "in": "query",<br>                        }<br>                    ],<br>                    "responses": {</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">"name": "level3",<br>                            "in": "query",<br>                        }<br>                    ],<br>                    "responses": {</code></pre></div></td>
    </tr>
    <tr>
      <td>snippet_schema</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from pydantic import BaseModel<br>import datetime<br><br><br>class SchedulingTimeRequest(BaseModel):<br>    # Battery charge in percentage [0-1] once the drive starts <br>    battery_charge: float<br><br>    # When the car will start to drive<br>    drive_start_time: datetime.datetime<br><br>[CURSOR]<br>class SchedulingTimeResponse(BaseModel):<br>    # When the car should charge<br>    recommended_starting_time: datetime.datetime</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">id = models.BigAutoField(primary_key=True)<br>    checkpoint = models.CharField(max_length=100)<br>    template_slug = models.CharField(max_length=100)<br>    prompt = models.TextField()<br>    n_prompt = models.TextField()<br>    sampler = models.CharField(max_length=50)<br>    cfg_scale = models.IntegerField(default=7)<br>    steps = models.IntegerField(default=30)<br>    seed = models.BigIntegerField(default=-1)<br>    sort_num = models.IntegerField(db_index=True, default=999)<br>    created_at = models.DateTimeField(auto_now_add=True, db_index=True)<br>    updated_at = models.DateTimeField(auto_now=True)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">app = FastAPI(<br>    title="ChimichangApp",<br>    description=description,<br>    summary="Deadpool's favorite app. Nuff said.",<br>    version="0.0.1",<br>    terms_of_service="http://example.com/terms/",<br>    contact={<br>        "name": "Deadpoolio the Amazing",<br>        "url": "http://x-force.example.com/contact/",<br>        "email": "dp@x-force.example.com",<br>    },<br>    license_info={<br>        "name": "Apache 2.0",<br>        "identifier": "MIT",<br>    },<br>)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import FastAPI<br>description = """<br>ChimichangApp API helps you do awesome stuff. 🚀<br>## Items<br>You can **read items**.<br>## Users<br>You will be able to:<br>* **Create users** (_not implemented_).<br>* **Read users** (_not implemented_).<br>"""<br>app = FastAPI(<br>    title="ChimichangApp",<br>    description=description,<br>    summary="Deadpool's favorite app. Nuff said.",<br>    version="0.0.1",<br>    terms_of_service="http://example.com/terms/",<br>    contact={<br>        "name": "Deadpoolio the Amazing",<br>        "url": "http://x-force.example.com/contact/",<br>        "email": "dp@x-force.example.com",<br>    },<br>    license_info={<br>        "name": "Apache 2.0",<br>        "identifier": "MIT",<br>    },<br>)<br>@app.get("/items/")<br>async def read_items():<br>    return [{"name": "Katana"}]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">start_time = time.time()</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">return level5</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">return level5</code></pre></div></td>
    </tr>
    <tr>
      <td>get_rooms_api</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@router.get("/rooms/{room_id}")<br>def get_room(request: Request, room_id: str) -> schemas.room:<br>    """Get room info"""<br>    user = request.state.user<br>    room = models.get_room(room_id)<br>    return schemas.Room(    [CURSOR]<br>        id=room.room_id,<br>        start_time=room.start_time,<br>        end_time=room.get_end_time(),<br>        num_rsvps=len(room.rsvps),<br>        has_user_rsvped=user.id in room.rsvps,<br>    )</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">data = res.json().get("data")<br>    assert data["id"] > 0<br>    assert data["username"] == "create"<br>    user = db.session.get(models.User, data["id"])<br>    assert user.id == data["id"], user<br>    db.session.delete(user)<br>    db.session.commit()<br>    # create bulk<br>    count = 3<br>    users = [<br>        {<br>            "id": i,<br>            "username": f"create_{i}",<br>            "password": "password",<br>            "create_time": f"2022-01-0{i + 1} 00:00:00",<br>        }<br>        for i in range(1, count + 1)<br>    ]<br>    res = client.post("/User/item", json=users)<br>    assert res.json()["data"] == count<br>    stmt = select(func.count(models.User.id))<br>    user = db.session.scalar(stmt)<br>    assert user == count<br>def test_route_read(client: TestClient, fake_users):<br>    # read one<br>    res = client.get("/User/item/1")<br>    user = res.json()["data"]<br>    assert user["id"] == 1<br>    assert user["username"] == "User_1"<br>    # read bulk<br>    res = client.get("/User/item/1,2,4")<br>    users = res.json()["data"]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">import pytest<br>from dirty_equals import IsDict<br>from fastapi.testclient import TestClient<br>from ...utils import needs_py39<br>@pytest.fixture(name="client")<br>def get_client():<br>    from docs_src.extra_data_types.tutorial001_an_py39 import app<br>    client = TestClient(app)<br>    return client<br>@needs_py39<br>def test_extra_types(client: TestClient):<br>    item_id = "ff97dd87-a4a5-4a12-b412-cde99f33e00e"<br>    data = {<br>        "start_datetime": "2018-12-22T14:00:00+00:00",<br>        "end_datetime": "2018-12-24T15:00:00+00:00",<br>        "repeat_at": "15:30:00",<br>        "process_after": 300,<br>    }<br>    expected_response = data.copy()<br>    expected_response.update(<br>        {<br>            "start_process": "2018-12-22T14:05:00+00:00",<br>            "duration": 176_100,<br>            "item_id": item_id,<br>        }<br>    )<br>    response = client.put(f"/items/{item_id}", json=data)<br>    assert response.status_code == 200, response.text<br>    assert response.json() == expected_response<br>@needs_py39</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">break<br>@pytest.mark.asyncio<br>async def test_chat_completion_resource_call():<br>    mocked_completion = ChatCompletion(<br>        id="chat-completion-id",<br>        created=1700936386,<br>        model="gpt-3.5-turbo-0613",<br>        object="chat.completion",<br>        choices=[<br>            chat_completion.Choice(<br>                finish_reason="stop",<br>                index=0,<br>                message=chat_completion.ChatCompletionMessage(<br>                    content="Hello! How can I assist you today?", role="assistant"<br>                ),<br>            )<br>        ],<br>    )<br>    chat_completion_resource = ChatCompletionResource(<br>        client=MagicMock(spec=AsyncOpenAI)<br>    )<br>    chat_completion_resource._client.chat = MagicMock()<br>    chat_completion_resource._client.chat.completions = MagicMock()<br>    chat_completion_resource._client.chat.completions.create = AsyncMock(<br>        return_value=mocked_completion<br>    )<br>    messages = [Message(role="user", content="Hello")]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@app.get("/")<br>async def root():<br>    return {"message": "Hello Bigger Applications!"}</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@app.get("/")<br>async def root():<br>    return {"message": "Hello Bigger Applications!"}</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">@app.get("/")<br>async def root():<br>    return {"message": "Hello Bigger Applications!"}</code></pre></div></td>
    </tr>
    <tr>
      <td>dependency_injection</td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from typing import Annotated<br>from fastapi import APIRouter, Depends, HTTPException, status<br>from pydantic import BaseModel<br>from prompto_server.agent.base_agent import BaseAgent<br>from prompto_server.db import PersistedMessage<br>from uuid import UUID<br>from dependency_injector.wiring import Provide, inject<br>from prompto_server.db.chat_history import FeedbackType<br>from prompto_server.db.session import Session<br>from prompto_server.routers.auth import current_user<br>from prompto_server import Container<br>from prompto_server.services.chat_service import AgentType, ChatService<br>from prompto_server.services.exceptions import NotFoundException<br><br>router = APIRouter(tags=["chat"])<br><br><br>class ChatRequest(BaseModel):<br>    id: str | None = None<br>    message: str<br><br><br>class ChatResponse(BaseModel):<br>    history_id: UUID<br>    messages: list[PersistedMessage]<br><br><br>@router.post("/chat/create")<br>@inject<br>async def create_chat(<br>    chat_rq: ChatRequest,<br>    session: Annotated[Session, Depends(current_user)],<br>    chat_service: ChatService = Depends(Provide[Container.chat_service]),<br>) -> ChatResponse:<br>    # Login Guard<br>    if not session:<br>        raise HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED, detail="Unauthorized"<br>        )<br><br>    if chat_rq.id:<br>        raise HTTPException(<br>            status_code=status.HTTP_400_BAD_REQUEST,<br>            detail="ID should not be provided when creating new chat",<br>        )<br><br>    agent: BaseAgent = chat_service.receive_agent(AgentType.DEBUG)<br><br>    if chat_rq.message.startswith("llm"):<br>        agent = chat_service.receive_agent(AgentType.PROMPTO)<br>        chat_rq.message = chat_rq.message[3:]<br><br>    try:<br>        history = await agent.create_chat(session, chat_rq.message)  # TODO Remove cut<br>    except Exception:<br>        raise HTTPException(<br>            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,<br>            detail="Error while generating response.",<br>        )<br><br>    return ChatResponse(<br>        history_id=history.history_id,<br>        messages=history.messages,<br>    )<br><br><br>class ChatRequest(BaseModel):<br>    id: str | None = None<br>    message: str<br><br><br>@router.post("/chat/continue")<br>@inject<br>async def continue_chat(<br>    chat_rq: ChatRequest,<br>    session: Annotated[Session, Depends(current_user)],<br>    chat_service=Depends(Provide[Container.chat_service]),<br>) -> ChatResponse:<br>    # Login Guard<br>    if not session:<br>        raise HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED, detail="Unauthorized"<br>        )<br><br>    if not chat_rq.id:<br>        raise HTTPException(<br>            status_code=status.HTTP_400_BAD_REQUEST,<br>            detail="ID should be provided when continuing chat",<br>        )<br><br>    agent: BaseAgent = chat_service.receive_agent(AgentType.DEBUG)<br>    history = await agent.continue_chat(session, chat_rq.id, chat_rq.message)<br><br>    # Create response<br>    return ChatResponse( [CURSOR]<br>        history_id=history.history_id,<br>        messages=history.messages,<br>    )<br><br><br>class FeedbackRequest(BaseModel):<br>    history_id: UUID<br>    message_id: UUID<br>    feedback_type: FeedbackType<br><br><br>class FeedbackResponse(BaseModel):<br>    history_id: UUID<br>    message_id: UUID<br>    feedback_type: FeedbackType<br><br><br>@router.post(<br>    "/chat/feedback",<br>    response_model=FeedbackResponse,<br>    responses={404: {"description": "Message not found"}},<br>)<br>@inject<br>async def feedback(<br>    feedback_rq: FeedbackRequest,<br>    session: Annotated[Session, Depends(current_user)],<br>    chat_service=Annotated[ChatService, Depends(Provide[Container.chat_service])],<br>):<br>    # Login Guard<br>    if not session:<br>        raise HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED, detail="Unauthorized"<br>        )<br><br>    try:<br>        await chat_service.feedback(<br>            session.uuid,<br>            feedback_rq.history_id,<br>            feedback_rq.message_id,<br>            feedback_rq.feedback_type,<br>        )<br>    except NotFoundException:<br>        raise HTTPException(<br>            status_code=status.HTTP_404_NOT_FOUND, detail="Message not found"<br>        )<br><br>    return FeedbackResponse(<br>        history_id=feedback_rq.history_id,<br>        message_id=feedback_rq.message_id,<br>        feedback_type=feedback_rq.feedback_type,<br>    )</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from unittest.mock import AsyncMock, MagicMock<br>import pytest<br>from openai.types.chat import chat_completion, chat_completion_chunk<br>from lanarky.adapters.openai.resources import (<br>    AsyncOpenAI,<br>    ChatCompletion,<br>    ChatCompletionChunk,<br>    ChatCompletionResource,<br>    Message,<br>)<br>@pytest.mark.asyncio<br>async def test_chat_completion_resource_stream_response():<br>    async def mock_completion_chunk_stream():<br>        yield ChatCompletionChunk(<br>            id="chat-completion-id",<br>            created=1700936386,<br>            model="gpt-3.5-turbo-0613",<br>            object="chat.completion.chunk",<br>            choices=[<br>                chat_completion_chunk.Choice(<br>                    index=0,<br>                    finish_reason=None,<br>                    delta=chat_completion_chunk.ChoiceDelta(<br>                        content="Hello! How can I assist you today?"<br>                    ),<br>                )<br>            ],<br>        )<br>    chat_completion_resource = ChatCompletionResource(</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">break<br>@pytest.mark.asyncio<br>async def test_chat_completion_resource_call():<br>    mocked_completion = ChatCompletion(<br>        id="chat-completion-id",<br>        created=1700936386,<br>        model="gpt-3.5-turbo-0613",<br>        object="chat.completion",<br>        choices=[<br>            chat_completion.Choice(<br>                finish_reason="stop",<br>                index=0,<br>                message=chat_completion.ChatCompletionMessage(<br>                    content="Hello! How can I assist you today?", role="assistant"<br>                ),<br>            )<br>        ],<br>    )<br>    chat_completion_resource = ChatCompletionResource(<br>        client=MagicMock(spec=AsyncOpenAI)<br>    )<br>    chat_completion_resource._client.chat = MagicMock()<br>    chat_completion_resource._client.chat.completions = MagicMock()<br>    chat_completion_resource._client.chat.completions.create = AsyncMock(<br>        return_value=mocked_completion<br>    )<br>    messages = [Message(role="user", content="Hello")]</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">history[-1][1] = ""<br>            for event in StreamingClient().stream_response(<br>                "POST", "/chat", json={"messages": messages}, params={"system": system}<br>            ):<br>                history[-1][1] += event.data<br>                yield history<br>        user_input.submit(<br>            lambda user_input, chatbot: ("", chatbot + [[user_input, None]]),<br>            [user_input, chatbot],<br>            [user_input, chatbot],<br>            queue=False,<br>        ).then(chat, [chatbot, system_message], chatbot)<br>        clear_btn.click(lambda: None, None, chatbot, queue=False)<br>    return gr.mount_gradio_app(app, blocks.queue(), "/")<br>app = mount_playground(app)<br>if __name__ == "__main__":<br>    import uvicorn<br>    uvicorn.run(app)</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">from fastapi import FastAPI, Response<br><br>app = FastAPI()<br><br><br>@app.get("/headers-and-object/")<br>def get_headers(response: Response):<br>    response.headers["X-Cat-Dog"] = "alone in the world"<br>    return {"message": "Hello World"}</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">Read more about it in the</code></pre></div></td>
      <td><div style="text-align: left; width: 450px; word-wrap: break-word; white-space: normal; overflow: hidden; background-color: #333"><pre><code style="background-color: #333">Read more about it in the</code></pre></div></td>
    </tr>
  </tbody>
</table>